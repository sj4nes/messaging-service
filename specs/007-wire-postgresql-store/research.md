# Research: Wire PostgreSQL Store

Created: 2025-11-06

## Decisions

- Decision: Use PostgreSQL (existing compose) with SQLx for durable inbound_events and messages
  - Rationale: Aligns with repo direction and existing db-migrate utility; supports offline mode via SQLX_OFFLINE
  - Alternatives: Diesel (more macros, less async-first); SeaORM (heavier ORM); Raw tokio-postgres (more boilerplate)

- Decision: IDs as UUID v4 (database-generated by gen_random_uuid())
  - Rationale: Simplicity and native Postgres support via pgcrypto/uuid-ossp; ULID considered but adds libs and ordering concerns not critical here
  - Alternatives: ULID (lexicographically sortable), Snowflake-style IDs (extra infra), sequential IDs (contention)

- Decision: Inbound event idempotency via unique index (channel, provider_message_id)
  - Rationale: Enforces at the DB layer; safe upsert avoids races under concurrent webhook deliveries
  - Alternatives: Application-level de-dupe caches (not durable), hash-based keys (requires extra storage)

- Decision: Worker claiming with SELECT ... FOR UPDATE SKIP LOCKED and status transitions
  - Rationale: Standard pattern for concurrent consumers; avoids thundering herd and supports safe parallelism
  - Alternatives: Advisory locks (harder to monitor); LISTEN/NOTIFY (complementary but not sufficient for durability)

- Decision: Claim timeout and heartbeat fields (processor_id, updated_at), reaping stale claims
  - Rationale: Ensures no stuck events after crashes; supports multi-instance workers
  - Alternatives: External queues (e.g., Redis) not in scope

- Decision: Backoff policy: exponential with jitter; max_retries = 5; park as dead_letter on exceed
  - Rationale: Prevents hot-looping; deterministic cap for operations
  - Alternatives: Linear backoff; unlimited retries (risk)

- Decision: Schema additions: inbound_events, messages, conversations (or conversation_keys materialized)
  - Rationale: Normalize and support queries; leverage indexes on (channel, from, to, timestamp)
  - Alternatives: Single table with JSONB (less queryable), EAV models (overkill)

- Decision: Migrations managed via existing db-migrate binary; ensure SQLX_OFFLINE=true compatibility
  - Rationale: Keeps CI happy and decouples DB availability from builds
  - Alternatives: Runtime migrations (less control)

## Clarifications Resolved

- No new external HTTP endpoints are introduced in this feature; existing endpoints will transparently use PostgreSQL instead of in-memory stores.
- Conversations and message listing read paths will be migrated to DB queries with pagination; response shape remains unchanged.
- Metrics will be extended (in implementation) to include worker throughput and failure counters; contract remains internal.

## Implementation Notes

- Ensure payload JSONB storage with a size cap (e.g., 256KB) and redaction for sensitive fields prior to persistence.
- Add NOT NULL and CHECK constraints where applicable; default timestamps to now() at DB.
- Maintain updated_at via trigger or application-side updates; application-side is acceptable initially.
- Add covering indexes for typical queries: inbound_events(status, next_attempt_at), messages(conversation_key, timestamp desc), conversations(last_activity_at desc).
